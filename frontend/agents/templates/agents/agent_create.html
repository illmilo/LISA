{% extends 'dashboard/dashboard.html' %}
{% load static %}
{% block style %}
<link rel="stylesheet" href="{% static 'agents/css/style.css' %}">
<style>
a.create-btn, a.edit-btn { text-decoration: none !important; }
.form-card { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px 0 rgba(80, 80, 120, 0.10), 0 1.5px 6px 0 rgba(80,80,120,0.08); padding: 36px 32px 28px 32px; margin: 0 auto 32px auto; max-width: 420px; display: flex; flex-direction: column; gap: 18px; }
.form-card label { font-weight: 500; color: #222; margin-bottom: 2px; display: flex; flex-direction: column; gap: 6px; }
.form-card input, .form-card select, .form-card textarea { border: 1.5px solid #e5e7eb; border-radius: 8px; padding: 8px 12px; font-size: 1rem; background: #f9fafb; transition: border 0.2s, box-shadow 0.2s; outline: none; }
.form-card input:focus, .form-card select:focus, .form-card textarea:focus { border: 1.5px solid #6366f1; box-shadow: 0 0 0 2px #a5b4fc44; background: #fff; }
.form-card button.create-btn { width: 100%; font-size: 1.1rem; padding: 12px 0; border-radius: 10px; margin-top: 10px; }
.form-card .checkbox-list label { background: #f3f4f6; border-radius: 8px; padding: 4px 10px; margin: 0 6px 6px 0; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
</style>
{% endblock %}
{% block content %}
<div class="main-content" style="max-width:1200px;margin:40px auto 0 auto;background:#181818;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.10);padding:32px 16px;">
    <a href="{% url 'agents' %}" class="create-btn" style="margin-bottom:24px;display:inline-block;">← К списку агентов</a>
    <h1 class="agent-detail-title" style="text-align:center;">Создать агента</h1>
    <form id="agent-form" class="form-card">
        <label>Имя:<input type="text" name="name" id="name" required maxlength="50"></label>
        <label>ОС:
            <select name="os" id="os" required>
                <option value="linux">linux</option>
                <option value="windows">windows</option>
            </select>
        </label>
        <label>Роль:
            <select name="role_id" id="role_id" required></select>
        </label>
        <label>Сервер:
            <select name="server_id" id="server_id" required></select>
        </label>
        <div style="margin:18px 0 8px 0;"><b>Активности:</b></div>
        <div id="activities-list" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
        <label>Время начала работы:<input type="time" name="work_start_time" id="work_start_time"></label>
        <label>Время окончания работы:<input type="time" name="work_end_time" id="work_end_time"></label>
        <label>Ставка активности:<input type="number" step="0.01" name="activity_rate" id="activity_rate"></label>
        <button type="submit" class="create-btn" style="margin-top:18px;display:block;margin-left:auto;margin-right:auto;">Создать</button>
    </form>
</div>
<div class="toast" id="toast"></div>
<script>
function showToast(msg, type='success') {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.className = 'toast show';
    if (type === 'error') toast.style.background = 'linear-gradient(90deg,#ef4444,#fca5a5)';
    else toast.style.background = '';
    setTimeout(() => { toast.className = 'toast'; toast.style.background = ''; }, 2500);
}
let allActivities = [];
let checkedIds = [];
let allRoles = [];
let allServers = [];
function renderActivities() {
    const list = document.getElementById('activities-list');
    list.innerHTML = '';
    allActivities.forEach(act => {
        const id = act.id;
        const label = document.createElement('label');
        label.style = 'display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;padding:4px 10px;border-radius:8px;cursor:pointer;';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = id;
        cb.checked = checkedIds.includes(id);
        cb.onchange = e => {
            if (e.target.checked) checkedIds.push(id);
            else checkedIds = checkedIds.filter(x => x !== id);
        };
        label.appendChild(cb);
        label.appendChild(document.createTextNode(act.name));
        list.appendChild(label);
    });
}
function renderRoles() {
    const select = document.getElementById('role_id');
    select.innerHTML = '';
    allRoles.forEach(role => {
        const opt = document.createElement('option');
        opt.value = role.id;
        opt.textContent = role.name;
        select.appendChild(opt);
    });
}
function renderServers() {
    const select = document.getElementById('server_id');
    select.innerHTML = '';
    allServers.forEach(server => {
        const opt = document.createElement('option');
        opt.value = server.id;
        opt.textContent = server.name;
        select.appendChild(opt);
    });
}
function setActivitiesByRole(roleId) {
    const role = allRoles.find(r => r.id == roleId);
    checkedIds = (role && Array.isArray(role.activity_ids)) ? role.activity_ids.slice() : [];
    renderActivities();
}
document.getElementById('role_id').onchange = function(e) {
    setActivitiesByRole(e.target.value);
};
fetch('http://localhost:8000/activities')
  .then(resp => resp.json())
  .then(data => { allActivities = data; renderActivities(); })
  .catch(() => showToast('Ошибка загрузки активностей', 'error'));
fetch('http://localhost:8000/roles/')
  .then(resp => resp.json())
  .then(data => { allRoles = data; renderRoles(); setActivitiesByRole(document.getElementById('role_id').value); })
  .catch(() => showToast('Ошибка загрузки ролей', 'error'));
fetch('http://localhost:8000/servers/')
  .then(resp => resp.json())
  .then(data => { allServers = data; renderServers(); })
  .catch(() => showToast('Ошибка загрузки серверов', 'error'));
document.getElementById('agent-form').onsubmit = function(e) {
    e.preventDefault();
    const data = {
        name: document.getElementById('name').value,
        os: document.getElementById('os').value,
        role_id: parseInt(document.getElementById('role_id').value),
        activity_ids: checkedIds,
        server_id: parseInt(document.getElementById('server_id').value),
        work_start_time: document.getElementById('work_start_time').value || null,
        work_end_time: document.getElementById('work_end_time').value || null,
        activity_rate: document.getElementById('activity_rate').value || null
    };
    fetch('http://localhost:8000/agents/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(resp => resp.json())
    .then(resp => {
        if (resp.id) {
            showToast('Агент создан!');
            setTimeout(() => location.href = `/agents/${resp.id}/`, 1200);
        } else if (resp.message) {
            showToast(resp.message, 'success');
            setTimeout(() => location.href = '/agents/', 1200);
        } else {
            showToast('Ошибка создания', 'error');
        }
    })
    .catch(() => showToast('Ошибка создания', 'error'));
};
</script>
{% endblock %} 