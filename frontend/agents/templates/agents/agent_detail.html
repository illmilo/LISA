{% extends 'dashboard/dashboard.html' %}
{% load static %}
{% block style %}
<link rel="stylesheet" href="{% static 'agents/css/style.css' %}">
{% endblock %}
{% block title %}Агент #{{ agent_id }}{% endblock %}
{% block content %}
<style>
a.create-btn, a.edit-btn {
    text-decoration: none !important;
}
</style>
<div class="main-content" style="max-width:600px;margin:auto;position:relative;">
    <a href="{% url 'agents' %}" class="create-btn" style="margin-bottom:24px;display:inline-block;background:linear-gradient(90deg,#6366f1,#a5b4fc);">← К списку агентов</a>
    <h1 style="margin-bottom:24px;">Детали агента</h1>
    <div class="item list-item" style="margin-bottom:32px;flex-direction:column;align-items:flex-start;">
        <div><b>Имя:</b> <span id="agent-name"></span></div>
        <div><b>Роль:</b> <span id="agent-role"></span></div>
        <div><b>OS:</b> <span id="agent-os"></span></div>
        <div><b>Статус:</b> <span id="agent-status"></span></div>
        <div><b>Время работы:</b> <span id="agent-work"></span></div>
    </div>
    <div style="display:flex; gap:16px; margin-bottom:30px;justify-content:center;">
        <button class="create-btn" onclick="startAgent({{ agent_id }})" style="background:linear-gradient(90deg,#22C55E,#15803D);">Запустить</button>
        <button class="create-btn" onclick="stopAgent({{ agent_id }})" style="background:linear-gradient(90deg,#fbbf24,#f59e42);">Остановить</button>
        <a href="/agents/{{ agent_id }}/edit/" class="edit-btn" title="Редактировать" style="position:absolute;top:18px;right:18px;padding:8px 12px;background:linear-gradient(90deg,#A855F7,#7E22CE);border-radius:8px;z-index:2;display:flex;align-items:center;gap:6px;color:white;text-decoration:none;">
            <i class="fa-solid fa-pen-to-square"></i>
        </a>
        <button class="create-btn" onclick="deleteAgent({{ agent_id }})" style="background:linear-gradient(90deg,#ef4444,#fca5a5);">Удалить</button>
    </div>
    <div id="activities-list" style="margin-top:30px;"></div>
</div>
<div class="toast" id="toast"></div>
<script>
function showToast(msg, type='success') {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.className = 'toast show';
    if (type === 'error') toast.style.background = 'linear-gradient(90deg,#ef4444,#fca5a5)';
    else toast.style.background = '';
    setTimeout(() => { toast.className = 'toast'; toast.style.background = ''; }, 2500);
}
let allRoles = [];
function loadAgent() {
    fetch('http://localhost:8000/roles/')
      .then(resp => resp.json())
      .then(roles => {
        allRoles = roles;
        fetch(`http://localhost:8000/agents/{{ agent_id }}`)
          .then(resp => resp.json())
          .then(data => {
              document.getElementById('agent-name').innerText = data.name;
              const role = allRoles.find(r => r.id === data.role_id);
              document.getElementById('agent-role').innerText = role ? role.name : (data.role_id || '—');
              document.getElementById('agent-os').innerText = data.os;
              document.getElementById('agent-status').innerText = data.agent_status || '—';
              document.getElementById('agent-work').innerText = (data.work_start_time || '-') + ' — ' + (data.work_end_time || '-');
          })
          .catch(() => showToast('Ошибка загрузки агента', 'error'));
      })
      .catch(() => showToast('Ошибка загрузки ролей', 'error'));
}
function startAgent(id) {
    fetch(`http://localhost:8000/agents/${id}/start_agent`, {method: 'POST'})
      .then(resp => resp.json())
      .then(data => showToast(data.status === 'ok' ? 'Агент запущен' : 'Ошибка запуска', data.status === 'ok' ? 'success' : 'error'));
}
function stopAgent(id) {
    fetch(`http://localhost:8000/agents/${id}/stop_agent`, {method: 'POST'})
      .then(resp => resp.json())
      .then(data => showToast(data.status === 'ok' ? 'Агент остановлен' : 'Ошибка остановки', data.status === 'ok' ? 'success' : 'error'));
}
function deleteAgent(id) {
    if (!confirm('Удалить агента?')) return;
    fetch(`http://localhost:8000/agents/${id}`, {method: 'DELETE'})
      .then(resp => resp.json())
      .then(data => {
          showToast('Агент удалён', 'success');
          setTimeout(() => location.href = '/agents/', 1200);
      })
      .catch(() => showToast('Ошибка удаления агента', 'error'));
}
document.addEventListener('DOMContentLoaded', loadAgent);
</script>
{% endblock %} 