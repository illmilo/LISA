{% extends 'dashboard/dashboard.html' %}
{% load static %}
{% block style %}
<link rel="stylesheet" href="{% static 'agents/css/style.css' %}">
{% endblock %}
{% block content %}
<style>
a.create-btn, a.edit-btn {
    text-decoration: none !important;
}
</style>
<div class="server-detail-main" style="max-width:600px;margin:auto;position:relative;">
    <a href="/servers/{{ server_id }}/edit/" class="edit-btn" title="Редактировать" style="position:absolute;top:18px;right:18px;z-index:2;">
        <i class="fa-solid fa-pen-to-square"></i>
    </a>
    <a href="{% url 'servers' %}" class="create-btn" style="margin-bottom:24px;display:inline-block;">← К списку серверов</a>
    <h1 class="server-detail-title">Детали сервера</h1>
    <div class="item list-item server-detail-card">
        <div><b>Имя:</b> <span id="server-name"></span></div>
        <div><b>Пароль:</b> <span id="server-password"></span></div>
        <div><b>Ключ:</b> <span id="server-key"></span></div>
        <div><b>ID:</b> <span id="server-id"></span></div>
    </div>
    <div style="display:flex; gap:16px; margin-bottom:30px;justify-content:center;">
        <button class="create-btn danger-btn" onclick="deleteServer({{ server_id }})">Удалить</button>
    </div>
    <h2 style="margin-bottom:12px;">Агенты на сервере</h2>
    <div class="list" id="server-agents-list"></div>
</div>
<div class="toast" id="toast"></div>
<script>
function showToast(msg, type='success') {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.className = 'toast show';
    if (type === 'error') toast.style.background = 'linear-gradient(90deg,#ef4444,#fca5a5)';
    else toast.style.background = '';
    setTimeout(() => { toast.className = 'toast'; toast.style.background = ''; }, 2500);
}
function loadServer() {
    fetch(`http://localhost:8000/servers/{{ server_id }}`)
      .then(resp => resp.json())
      .then(data => {
          document.getElementById('server-name').innerText = data.name;
          document.getElementById('server-password').innerText = data.password;
          document.getElementById('server-key').innerText = data.server_key;
          document.getElementById('server-id').innerText = data.id;
      })
      .catch(() => showToast('Ошибка загрузки сервера', 'error'));
    fetch(`http://localhost:8000/servers/{{ server_id }}/agents`)
      .then(resp => resp.json())
      .then(data => {
          const list = document.getElementById('server-agents-list');
          list.innerHTML = '';
          if (!data.length) {
              list.innerHTML = '<div style="color:#888;">Нет агентов на этом сервере</div>';
              return;
          }
          data.forEach(agent => {
              const div = document.createElement('div');
              div.className = 'item list-item';
              div.innerHTML = `<span>${agent.name}</span> <span style='color:#aaa;'>ID: ${agent.id}</span>`;
              div.onclick = () => location.href = `/agents/${agent.id}/`;
              list.appendChild(div);
          });
      })
      .catch(() => showToast('Ошибка загрузки агентов сервера', 'error'));
}
function deleteServer(id) {
    if (!confirm('Удалить сервер?')) return;
    fetch(`http://localhost:8000/servers/${id}`, {method: 'DELETE'})
      .then(resp => resp.json())
      .then(data => {
          showToast('Сервер удалён', 'success');
          setTimeout(() => location.href = '/servers/', 1200);
      })
      .catch(() => showToast('Ошибка удаления сервера', 'error'));
}
document.addEventListener('DOMContentLoaded', loadServer);
</script>
{% endblock %} 